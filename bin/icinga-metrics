#!/usr/bin/php
<?php

use GetOpt\ArgumentException;
use GetOpt\GetOpt;
use GetOpt\Operand;
use gipfl\Cli\Process;
use gipfl\SimpleDaemon\Daemon;
use IcingaMetrics\Application;
use IcingaMetrics\DataNode;
use IcingaMetrics\DataNodeRunner;
use React\EventLoop\Loop;
use React\EventLoop\StreamSelectLoop;

require_once dirname(__DIR__) . '/vendor/autoload.php';
error_reporting(E_ALL | E_STRICT);

$options = new GetOpt(null, [GetOpt::SETTING_STRICT_OPERANDS => true]);
$options->addOperand(Operand::create('directory'));
try {
    $options->process();
} catch (ArgumentException $e) {
    echo $options->getHelpText();
    exit(1);
}
Process::setTitle(Application::PROCESS_NAME);
$home = $options->getOperand('directory');
$home ??= $_ENV['HOME'] ?? $_SERVER['HOME'];
if ($home === null) {
    echo "Got no --directory and could not detect \$HOME\n";
    exit(1);
}
$logger = include __DIR__ . '/logger.inc.php';

if (Loop::get() instanceof StreamSelectLoop) {
    $logger->warning('Please install php-ev for better performance');
}

$daemon = new Daemon();
$daemon->attachTask(new DataNodeRunner(new DataNode($home, $logger)));
$daemon->run(Loop::get());
Loop::run();
