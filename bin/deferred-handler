#!/usr/bin/php
<?php

use gipfl\RrdTool\AsyncRrdtool;
use gipfl\RrdTool\RrdCached\Client as RrdCachedClient;
use IcingaMetrics\DeferredHandler;
use IcingaMetrics\InstanceConfig;
use IcingaMetrics\Main;
use IcingaMetrics\RedisPerfDataApi;

require_once dirname(__DIR__) . '/vendor/autoload.php';
$config = include __DIR__ . '/config.inc.php';

$instanceConfig = new InstanceConfig($config->basedir);
$main = new Main();
$redis = new RedisPerfDataApi($main->getLoop(), $main->getLogger(), $instanceConfig->getRedisSocketUri());
$redis->setClientName('IcingaGraphing::deferred');
$rrdCached = new RrdCachedClient($config->rrdcached->socket, $main->getLoop());
$deferredHandler = new DeferredHandler($redis, $rrdCached, $main->getLogger());
$baseDir = '/var/lib/icingagraphing/rrd/data';
chdir($baseDir);
$deferredHandler->run($main->getLoop());
$main->startLoop();
